<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetGuard AI v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        .card { border: 1px solid #333; background-color: #1e1e2d; }
        .table-responsive { max-height: 300px; overflow-y: auto; }
        .log-text { font-family: monospace; font-size: 0.85rem; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    </style>
</head>
<body class="bg-black text-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary">
        <div class="container-fluid">
            <a class="navbar-brand text-info fw-bold" href="#">NetGuard AI</a>
            <span class="navbar-text text-light" id="connectionStatus">ðŸ”´ Disconnected</span>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3 text-center">
                    <h6 class="text-secondary">Network Speed</h6>
                    <h2 class="text-info" id="speedValue">0 KB/s</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center">
                    <h6 class="text-secondary">Total Packets</h6>
                    <h2 class="text-light" id="totalPkts">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center">
                    <h6 class="text-secondary">Top Protocol</h6>
                    <h2 class="text-warning" id="topProto">-</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center border-danger">
                    <h6 class="text-danger">Threats Detected</h6>
                    <h2 class="text-danger" id="threatCount">0</h2>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Traffic Composition</div>
                    <div class="card-body">
                        <canvas id="protoChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header">Real-time Throughput (KB/s)</div>
                    <div class="card-body">
                        <canvas id="speedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">Top Active IPs (Bandwidth)</div>
                    <ul class="list-group list-group-flush" id="topIpList">
                        </ul>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-info text-dark">Live Packet Feed</div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-striped log-text">
                            <thead>
                                <tr><th>Time</th><th>Source</th><th>Dest</th><th>Proto</th><th>Size</th></tr>
                            </thead>
                            <tbody id="packetTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">Security Alerts</div>
                    <div class="card-body p-2" id="alertBox">
                        <span class="text-secondary">No threats detected yet...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let threatCounter = 0;

        // --- CHARTS SETUP ---
        // 1. Protocol Doughnut Chart
        const ctxProto = document.getElementById('protoChart').getContext('2d');
        const protoChart = new Chart(ctxProto, {
            type: 'doughnut',
            data: { labels: ['TCP', 'UDP', 'Other'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#0dcaf0', '#ffc107', '#6c757d'] }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        // 2. Speed Line Chart
        const ctxSpeed = document.getElementById('speedChart').getContext('2d');
        const speedChart = new Chart(ctxSpeed, {
            type: 'line',
            data: { 
                labels: Array(60).fill(''), 
                datasets: [{ label: 'KB/s', data: Array(60).fill(0), borderColor: '#20c997', tension: 0.4, fill: true, backgroundColor: 'rgba(32, 201, 151, 0.1)' }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { display: false } },
                animation: false // Disable animation for performance
            }
        });

        // --- SOCKET EVENTS ---
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').innerText = "ðŸŸ¢ Connected";
            document.getElementById('connectionStatus').classList.replace('text-light', 'text-success');
        });

        // 1. Live Packet Stream
        socket.on('packet', (data) => {
            const table = document.getElementById('packetTable');
            const row = `<tr><td>${data.time}</td><td>${data.src}</td><td>${data.dst}</td><td><span class="badge bg-secondary">${data.proto}</span></td><td>${data.size}</td></tr>`;
            table.insertAdjacentHTML('afterbegin', row);
            if (table.rows.length > 20) table.deleteRow(-1);
        });

        // 2. Aggregated Stats (Every 1 Second)
        socket.on('stats_update', (data) => {
            // Update KPIs
            document.getElementById('speedValue').innerText = data.kbps + " KB/s";
            document.getElementById('totalPkts').innerText = data.total_packets;
            
            // Update Speed Chart
            speedChart.data.datasets[0].data.push(data.kbps);
            speedChart.data.datasets[0].data.shift();
            speedChart.update();

            // Update Proto Chart
            const p = data.protocols;
            protoChart.data.datasets[0].data = [p.TCP || 0, p.UDP || 0, (p.ICMP || 0) + (p.OTHER || 0)];
            protoChart.update();

            // Update Top IPs List
            const list = document.getElementById('topIpList');
            list.innerHTML = "";
            data.top_ips.forEach(([ip, bytes]) => {
                let sizeStr = bytes > 1024 * 1024 ? (bytes/1024/1024).toFixed(1) + " MB" : (bytes/1024).toFixed(1) + " KB";
                list.innerHTML += `<li class="list-group-item bg-dark text-light d-flex justify-content-between"><span>${ip}</span> <span class="text-info">${sizeStr}</span></li>`;
            });
        });

        // 3. Alerts
        socket.on('new_alert', (data) => {
            threatCounter++;
            document.getElementById('threatCount').innerText = threatCounter;
            
            const alertBox = document.getElementById('alertBox');
            const alertHtml = `<div class="alert alert-danger py-1 mb-1">
                <strong>${data.type}</strong> from ${data.src}: ${data.msg} <small class="float-end">${data.timestamp}</small>
            </div>`;
            alertBox.insertAdjacentHTML('afterbegin', alertHtml);
        });

    </script>
</body>
</html>